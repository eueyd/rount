<!DOCTYPE html>
<html>
<head>
    <!-- 头部内容保持不变 -->
    <style>
        /* 添加错误提示样式 */
        .error-message {
            color: red;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid red;
            border-radius: 4px;
            background-color: #fff3f3;
        }
        
        #debug-panel {
            margin-top: 20px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 200px;
        }
        
        /* 其他样式保持不变 */
        ...
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>成都景点路线规划</h2>
        <div class="form-group">
            <label for="start-point">选择起点：</label>
            <select id="start-point"></select>
        </div>
        <div class="form-group">
            <label for="end-point">选择终点：</label>
            <select id="end-point"></select>
        </div>
        <button onclick="planRoute()" class="btn btn-primary">开始规划路线</button>
        <button onclick="resetMap()" class="btn btn-danger">重置地图</button>
        <div id="result-panel"></div>
        <div id="debug-panel"></div> <!-- 新增调试面板 -->
    </div>
    <div id="map-container"></div>

    <script>
        // 添加调试日志函数
        function debug(message, isError = false) {
            const debugPanel = document.getElementById('debug-panel');
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${message}`;
            console.log(logMessage);
            
            const logElement = document.createElement('div');
            logElement.style.color = isError ? 'red' : 'black';
            logElement.textContent = logMessage;
            debugPanel.appendChild(logElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        // 初始化地图
        function initMap() {
            try {
                debug('开始初始化地图...');
                
                map = new AMap.Map('map-container', {
                    zoom: 12,
                    center: [104.066801, 30.572961],
                    viewMode: '3D'
                });

                debug('地图实例创建成功');

                // 添加控件
                map.plugin(['AMap.Scale', 'AMap.ToolBar'], function() {
                    try {
                        map.addControl(new AMap.Scale());
                        map.addControl(new AMap.ToolBar());
                        debug('地图控件添加成功');
                    } catch (error) {
                        debug('添加地图控件失败: ' + error.message, true);
                    }
                });

                // 初始化路线规划服务
                try {
                    driving = new AMap.Driving({
                        map: map,
                        panel: "result-panel",
                        policy: AMap.DrivingPolicy.LEAST_TIME
                    });
                    debug('路线规划服务初始化成功');
                } catch (error) {
                    debug('路线规划服务初始化失败: ' + error.message, true);
                }

                // 添加标记点
                debug('开始添加位置标记...');
                locations.forEach((location, index) => {
                    try {
                        const marker = new AMap.Marker({
                            position: [location.lng, location.lat],
                            title: location.name,
                            animation: 'AMAP_ANIMATION_DROP'
                        });

                        marker.on('click', () => {
                            new AMap.InfoWindow({
                                content: `<div style="padding:10px;">
                                           <h3>${location.name}</h3>
                                           <p>经度：${location.lng}<br>纬度：${location.lat}</p>
                                         </div>`
                            }).open(map, marker.getPosition());
                        });

                        marker.setMap(map);
                        markers.push(marker);
                        debug(`标记点添加成功: ${location.name}`);
                    } catch (error) {
                        debug(`添加标记点失败 [${location.name}]: ${error.message}`, true);
                    }
                });

                // 初始化选择框
                initSelectors();
                debug('地图初始化完成');
            } catch (error) {
                debug('地图初始化失败: ' + error.message, true);
                throw error;
            }
        }

        // 初始化选择框
        function initSelectors() {
            try {
                const startSelect = document.getElementById('start-point');
                const endSelect = document.getElementById('end-point');
                
                locations.forEach((location, index) => {
                    const option = new Option(location.name, index);
                    startSelect.add(option.cloneNode(true));
                    endSelect.add(option);
                });
                debug('选择框初始化完成');
            } catch (error) {
                debug('选择框初始化失败: ' + error.message, true);
            }
        }

        // 规划路线
        async function planRoute() {
            debug('开始规划路线...');
            const startIndex = parseInt(document.getElementById('start-point').value);
            const endIndex = parseInt(document.getElementById('end-point').value);

            if (startIndex === endIndex) {
                debug('起点和终点相同', true);
                alert('起点和终点不能相同！');
                return;
            }

            try {
                const start = locations[startIndex];
                const end = locations[endIndex];
                
                debug(`规划路线: 从 ${start.name} 到 ${end.name}`);

                driving.search(
                    [start.lng, start.lat],
                    [end.lng, end.lat],
                    function(status, result) {
                        if (status === 'complete') {
                            document.getElementById('result-panel').style.display = 'block';
                            debug('路线规划成功');
                            debug(`路线详情: ${JSON.stringify(result.routes[0].distance)} 米`);
                        } else {
                            debug('路线规划失败: ' + result, true);
                            alert('路线规划失败：' + result);
                        }
                    }
                );
            } catch (error) {
                debug('路线规划出错: ' + error.message, true);
                alert('路线规划失败，请查看调试信息');
            }
        }

        // 重置地图
        function resetMap() {
            try {
                driving.clear();
                document.getElementById('result-panel').style.display = 'none';
                map.setZoomAndCenter(12, [104.066801, 30.572961]);
                debug('地图重置成功');
            } catch (error) {
                debug('地图重置失败: ' + error.message, true);
            }
        }

        // 页面加载完成后初始化
        window.onload = function() {
            debug('页面加载完成，开始初始化...');
            try {
                initMap();
            } catch (error) {
                debug('初始化失败: ' + error.message, true);
            }
        };

        // 添加错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            debug(`全局错误: ${message}\n来源: ${source}\n行号: ${lineno}`, true);
            return false;
        };
    </script>
</body>
</html>