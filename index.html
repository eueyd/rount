<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成都景点路线规划</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            height: 100vh;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #sidebar {
            width: 300px;
            background: #f5f5f5;
            padding: 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #map-container {
            flex: 1;
            height: 100%;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            margin-bottom: 10px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
            width: 100%;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #409EFF;
            color: white;
        }

        .btn-primary:hover {
            background-color: #66b1ff;
        }

        .btn-danger {
            background-color: #F56C6C;
            color: white;
            margin-top: 10px;
        }

        .btn-danger:hover {
            background-color: #f78989;
        }

        #result-panel {
            margin-top: 20px;
            background: white;
            border-radius: 4px;
            padding: 10px;
            flex: 1;
            overflow-y: auto;
            display: none;
        }

        h2 {
            color: #303133;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #409EFF;
        }

        #debug-panel {
            margin-top: 20px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 200px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                max-height: 40vh;
            }

            #map-container {
                height: 60vh;
            }
        }

        .route-marker {
            background-color: #2d8cf0;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
        }

        .path-description {
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            margin-top: 10px;
        }

        .path-description h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .path-description ol {
            margin: 0;
            padding-left: 20px;
        }

        .path-description li {
            margin: 5px 0;
            color: #666;
        }

        .distance-info {
            background: #e8f7ff;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .distance-info p {
            margin: 5px 0;
            color: #2d8cf0;
        }

        #result-panel {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #e8e8e8;
            border-radius: 4px;
        }
    </style>
    <!-- 引入本地的 JSCPP -->
    <script src="lib/jscpp.js"></script>
</head>

<body>
    <div id="sidebar">
        <h2>成都景点路线规划</h2>
        <div class="form-group">
            <label for="start-point">选择起点：</label>
            <select id="start-point"></select>
        </div>
        <div class="form-group">
            <label for="end-point">选择终点：</label>
            <select id="end-point"></select>
        </div>
        <button onclick="planRoute()" class="btn btn-primary">开始规划路线</button>
        <button onclick="resetMap()" class="btn btn-danger">重置地图</button>
        <div id="result-panel"></div>
        <div id="debug-panel"></div>
    </div>
    <div id="map-container"></div>

    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '9cf010b11855b6a170165c8258a4ff8a',
        }
    </script>
    <script type="text/javascript"
        src="https://webapi.amap.com/maps?v=2.0&key=6ebca79a4a23917ec971808d8d249dc1&plugin=AMap.Scale,AMap.ToolBar,AMap.Driving"></script>

    <script>
        const locations = [
            { name: "东湖公园", lng: 104.088051, lat: 30.61663 },
            { name: "成都东站", lng: 104.140665, lat: 30.629924 },
            { name: "川大望江", lng: 104.083759, lat: 30.631106 },
            { name: "杜甫草堂", lng: 104.028289, lat: 30.660648 },
            { name: "成都动物园", lng: 104.106309, lat: 30.710546 },
            { name: "文殊院", lng: 104.072664, lat: 30.676004 },
            { name: "青龙湖", lng: 104.194739, lat: 30.633593 },
            { name: "川大江安", lng: 103.999861, lat: 30.558013 },
            { name: "双流机场", lng: 103.956033, lat: 30.569634 },
            { name: "四川博物馆", lng: 104.034137, lat: 30.660788 },
            { name: "四川科技馆", lng: 104.065755, lat: 30.660299 },
            { name: "太古里", lng: 104.083645, lat: 30.653435 },
            { name: "春熙路", lng: 104.077165, lat: 30.655798 },
            { name: "东郊记忆", lng: 104.122926, lat: 30.668902 },
            { name: "锦里", lng: 104.049846, lat: 30.646057 },
            { name: "川大华西", lng: 104.06757, lat: 30.641278 },
            { name: "成都图书馆", lng: 104.060747, lat: 30.653056 },
            { name: "万达", lng: 103.926541, lat: 30.596249 },
            { name: "大悦城", lng: 104.011748, lat: 30.625779 },
            { name: "都江堰", lng: 103.610714, lat: 31.004114 },
            { name: "天府公园", lng: 104.072418, lat: 30.433763 }
        ];

        let map, driving, markers = [];

        function debug(message, isError = false) {
            const debugPanel = document.getElementById('debug-panel');
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${message}`;
            console.log(logMessage);

            const logElement = document.createElement('div');
            logElement.style.color = isError ? 'red' : 'black';
            logElement.textContent = logMessage;
            debugPanel.appendChild(logElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        function initMap() {
            try {
                debug('开始初始化地图...');

                map = new AMap.Map('map-container', {
                    zoom: 12,
                    center: [104.066801, 30.572961],
                    viewMode: '3D'
                });

                debug('地图实例创建成功');

                map.plugin(['AMap.Scale', 'AMap.ToolBar'], function () {
                    try {
                        map.addControl(new AMap.Scale());
                        map.addControl(new AMap.ToolBar());
                        debug('地图控件添加成功');
                    } catch (error) {
                        debug('添加地图控件失败: ' + error.message, true);
                    }
                });

                try {
                    driving = new AMap.Driving({
                        map: map,
                        panel: "result-panel",
                        policy: AMap.DrivingPolicy.LEAST_TIME
                    });
                    debug('路线规划服务初始化成功');
                } catch (error) {
                    debug('路线规划服务初始化失败: ' + error.message, true);
                }

                debug('开始添加位置标记...');
                locations.forEach((location, index) => {
                    try {
                        const marker = new AMap.Marker({
                            position: [location.lng, location.lat],
                            title: location.name,
                            animation: 'AMAP_ANIMATION_DROP'
                        });

                        marker.on('click', () => {
                            new AMap.InfoWindow({
                                content: `<div style="padding:10px;">
                                           <h3>${location.name}</h3>
                                           <p>经度：${location.lng}<br>纬度：${location.lat}</p>
                                         </div>`
                            }).open(map, marker.getPosition());
                        });

                        marker.setMap(map);
                        markers.push(marker);
                        debug(`标记点添加成功: ${location.name}`);
                    } catch (error) {
                        debug(`添加标记点失败 [${location.name}]: ${error.message}`, true);
                    }
                });

                initSelectors();
                debug('地图初始化完成');
            } catch (error) {
                debug('地图初始化失败: ' + error.message, true);
                throw error;
            }
        }

        function initSelectors() {
            try {
                const startSelect = document.getElementById('start-point');
                const endSelect = document.getElementById('end-point');

                locations.forEach((location, index) => {
                    const option = new Option(location.name, index);
                    startSelect.add(option.cloneNode(true));
                    endSelect.add(option);
                });
                debug('选择框初始化完成');
            } catch (error) {
                debug('选择框初始化失败: ' + error.message, true);
            }
        }



        let JSCPP_READY = false;

        //checkJSCPP 函数
        function checkJSCPP() {
            return new Promise((resolve, reject) => {
                if (typeof JSCPP !== 'undefined') {
                    JSCPP_READY = true;
                    log('JSCPP 加载成功');
                    resolve();
                } else {
                    log('JSCPP 未加载，尝试重新加载...');
                    const script = document.createElement('script');
                    script.src = "lib/jscpp.js";  // 使用本地路径
                    script.onload = () => {
                        JSCPP_READY = true;
                        log('JSCPP 重新加载成功');
                        resolve();
                    };
                    script.onerror = () => {
                        const error = 'JSCPP 加载失败';
                        log(error);
                        reject(new Error(error));
                    };
                    document.head.appendChild(script);
                }
            });
        }



        function processError(output) {
            const lines = output.split('\n');
            for (const line of lines) {
                if (line.startsWith('ERROR:')) {
                    return line.substring(7).trim();
                }
            }
            return null;
        }

        // 修复 processOutput 函数
        function processOutput(output) {
            const lines = output.trim().split('\n');
            const pathLine = lines.find(line => !line.startsWith('DEBUG:') && line.trim().length > 0);

            if (!pathLine) {
                throw new Error('没有找到有效的路径输出');
            }

            if (pathLine.trim() === 'NO_PATH') {
                throw new Error('找不到有效路径');
            }

            return pathLine.trim();
        }

        // 修复 planRoute 函数
        async function planRoute() {
            try {
                await checkJSCPP();
                log('开始规划路线...');

                const startSelect = document.getElementById('start-point');
                const endSelect = document.getElementById('end-point');

                const startIndex = parseInt(startSelect.value);
                const endIndex = parseInt(endSelect.value);

                log(`起点索引: ${startIndex}, 终点索引: ${endIndex}`);

                if (startIndex === endIndex) {
                    throw new Error('起点和终点不能相同');
                }

                const start = locations[startIndex];
                const end = locations[endIndex];

                log(`规划路线: 从 ${start.name}(${startIndex}) 到 ${end.name}(${endIndex})`);

                // 读取 C++ 代码文件
                const response = await fetch('route_planner.cpp');
                if (!response.ok) {
                    throw new Error('无法加载 C++ 代码文件');
                }
                const cppCode = await response.text();

                // 准备输入数据
                const input = `${startIndex} ${endIndex}\n`;

                // 配置 JSCPP 运行选项
                const config = {
                    stdio: {
                        write: function (s) {
                            log("C++ 输出: " + s);
                        }
                    }
                };

                // 执行 C++ 代码并处理结果
                try {
                    const output = JSCPP.run(cppCode, input, config);
                    log("C++ 执行结果: " + output);

                    // 解析输出
                    const lines = output.trim().split('\n');
                    const pathLine = lines.find(line => line.startsWith('PATH:'));
                    const distanceLine = lines.find(line => line.startsWith('DISTANCE:'));

                    if (!pathLine) {
                        throw new Error('未找到有效路径输出');
                    }

                    const path = pathLine.replace('PATH:', '').trim().split(' ').map(Number);
                    let totalDistance = 0;

                    if (distanceLine) {
                        totalDistance = parseFloat(distanceLine.replace('DISTANCE:', '').trim());
                        log(`总距离: ${totalDistance.toFixed(2)} 公里`);
                    }

                    // 转换为坐标点
                    const points = path.map(index => {
                        const location = locations[index];
                        return [location.lng, location.lat];
                    });

                    log(`生成的坐标点: ${JSON.stringify(points)}`);

                    // 显示结果面板
                    const resultPanel = document.getElementById('result-panel');
                    resultPanel.style.display = 'block';
                    resultPanel.innerHTML = `
                <div class="path-description">
                    <h3>推荐路线</h3>
                    <div class="distance-info">
                        <p>总距离: ${totalDistance.toFixed(2)} 公里</p>
                    </div>
                    <ol>
                        ${path.map(index => `<li>${locations[index].name}</li>`).join('')}
                    </ol>
                </div>
            `;

                    // 绘制路线
                    driving.clear();
                    log('开始调用高德地图API...');

                    driving.search(
                        points[0],
                        points[points.length - 1],
                        {
                            waypoints: points.slice(1, -1)
                        },
                        function (status, result) {
                            if (status === 'complete') {
                                log('路线规划成功');
                            } else {
                                log(`路线规划失败: ${status}`);
                                alert(`路线规划失败: ${status}`);
                            }
                        }
                    );
                } catch (error) {
                    throw new Error('C++ 代码执行错误: ' + error.message);
                }
            } catch (error) {
                log(`错误: ${error.message}`, true);
                alert(error.message);
            }
        }
        document.addEventListener('DOMContentLoaded', checkJSCPP);

        // 调试信息输出函数
        function log(message) {
            const now = new Date();
            const time = now.toLocaleTimeString();
            const debugPanel = document.getElementById('debug-panel');
            if (debugPanel) {
                debugPanel.innerHTML += `[${time}] ${message}<br>`;
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
            console.log(`[${time}] ${message}`);
        }

        // 确保调试面板存在
        document.addEventListener('DOMContentLoaded', function () {
            if (!document.getElementById('debug-panel')) {
                const panel = document.createElement('div');
                panel.id = 'debug-panel';
                panel.style.cssText = `
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 12px;
        `;
                document.getElementById('sidebar').appendChild(panel);
            }
        });

        function resetMap() {
            try {
                driving.clear();
                document.getElementById('result-panel').style.display = 'none';
                map.setZoomAndCenter(12, [104.066801, 30.572961]);
                debug('地图重置成功');
            } catch (error) {
                debug('地图重置失败: ' + error.message, true);
            }
        }

        window.onload = function () {
            debug('页面加载完成，开始初始化...');
            try {
                initMap();
            } catch (error) {
                debug('初始化失败: ' + error.message, true);
            }
        };

        window.onerror = function (message, source, lineno, colno, error) {
            debug(`全局错误: ${message}\n来源: ${source}\n行号: ${lineno}`, true);
            return false;
        };

        // 初始化地图
var map = new TMap.Map(document.getElementById('map'), {
    center: new TMap.LatLng(30.658543, 104.065754),
    zoom: 13
});

// 存储路径点的数组
let pathPoints = [];
let polylineLayer = null;

// 创建路径展示函数
function showPath(points) {
    // 如果已经有路径，先清除
    if (polylineLayer) {
        polylineLayer.destroy();
    }
    
    // 创建路径线条样式
    const lineStyle = {
        'path-0': {
            color: '#FF0000', // 红色路径
            width: 4, // 线条宽度
            borderWidth: 1, // 边框宽度
            showArrow: true // 显示箭头
        }
    };
    
    // 构建路径坐标数组
    const path = points.map(point => {
        return new TMap.LatLng(point.lat, point.lng);
    });
    
    // 创建折线对象
    polylineLayer = new TMap.MultiPolyline({
        id: 'path-layer',
        map: map,
        styles: lineStyle,
        geometries: [{
            id: 'path-0',
            paths: [path]
        }]
    });
}

// 处理迪杰斯特拉算法结果并显示路径
function visualizePath(shortestPath) {
    // shortestPath 是您的C++算法计算出的最短路径点数组
    // 需要将路径点转换为经纬度坐标
    const pathCoordinates = shortestPath.map(point => ({
        lat: point.latitude,
        lng: point.longitude
    }));
    
    // 显示路径
    showPath(pathCoordinates);
}

// 选点事件处理
let startPoint = null;
let endPoint = null;

map.on('click', function(evt) {
    const latLng = evt.latLng;
    
    if (!startPoint) {
        startPoint = latLng;
        // 添加起点标记
        new TMap.MultiMarker({
            map: map,
            styles: {
                "start": new TMap.MarkerStyle({
                    width: 25,
                    height: 35,
                    anchor: { x: 12.5, y: 35 },
                    src: 'start-marker.png'
                })
            },
            geometries: [{
                id: 'start',
                position: startPoint,
                styleId: 'start'
            }]
        });
    } else if (!endPoint) {
        endPoint = latLng;
        // 添加终点标记
        new TMap.MultiMarker({
            map: map,
            styles: {
                "end": new TMap.MarkerStyle({
                    width: 25,
                    height: 35,
                    anchor: { x: 12.5, y: 35 },
                    src: 'end-marker.png'
                })
            },
            geometries: [{
                id: 'end',
                position: endPoint,
                styleId: 'end'
            }]
        });
        
        // 调用您的C++迪杰斯特拉算法
        // 这里需要通过WebAssembly或其他方式与C++代码交互
        calculateShortestPath(startPoint, endPoint);
    }
});

// 清除路径按钮事件处理
document.getElementById('clearPath').onclick = function() {
    if (polylineLayer) {
        polylineLayer.destroy();
    }
    startPoint = null;
    endPoint = null;
    // 清除标记
    map.remove('start');
    map.remove('end');
};
    </script>
</body>

</html>